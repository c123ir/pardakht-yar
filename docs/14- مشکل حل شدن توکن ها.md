به نظر می‌رسد تغییرات ما تا حد زیادی موفقیت‌آمیز بوده و اکثر قسمت‌ها درست کار می‌کنند، اما همچنان بخش پرداخت‌ها مشکل دارد.

## داکیومنت مدیریت توکن JWT و اتصال به API در پروژه پرداخت‌یار

این داکیومنت اصول کلیدی مدیریت توکن JWT در برنامه و شیوه‌های صحیح اتصال به API را توضیح می‌دهد.

### ۱. اصول کلیدی مدیریت توکن

1. **یکپارچگی کلید JWT**: 
   - کلید مخفی JWT باید در یک مکان مرکزی تعریف شود (فایل `config/app.ts`)
   - از همان کلید هم در سرور (برای تولید و تأیید) و هم در کلاینت (برای تأیید) استفاده شود
   - از مقادیر پیش‌فرض متفاوت در قسمت‌های مختلف کد استفاده نشود

2. **مدیریت توکن در سمت کلاینت**:
   - توکن باید فقط در `localStorage` ذخیره شودw
   - قبل از استفاده از توکن، اعتبار آن باید بررسی شود (تاریخ انقضا)
   - در صورت منقضی شدن توکن، باید پاک شود و کاربر به صفحه ورود هدایت شود

3. **استفاده یکپارچه از axios**:
   - همیشه از یک نمونه یکسان از `axios` در همه سرویس‌ها استفاده کنید
   - تمامی درخواست‌ها باید از `utils/axios.ts` استفاده کنند، نه از نمونه‌های جداگانه
   - از `api.ts` استفاده نکنید - این باعث تداخل در مدیریت توکن می‌شود

4. **مدیریت خطاهای احراز هویت**:
   - خطاهای 401 باید به طور خودکار کاربر را از سیستم خارج کنند
   - فقط یک پیام خطا نمایش داده شود تا از پیام‌های متعدد جلوگیری شود
   - بعد از خروج کاربر، باید به صفحه ورود هدایت شود

### ۲. عیب‌یابی مشکلات رایج

1. **توکن نامعتبر**:
   - بررسی کنید کلید JWT در فایل `.env` سرور و کلاینت یکسان باشد
   - بررسی کنید زمان انقضای توکن به درستی تنظیم شده باشد
   - کل کش مرورگر را پاک کنید و دوباره وارد سیستم شوید

2. **مشکل در درخواست‌های API**:
   - بررسی کنید همه سرویس‌ها از `axios` از فایل `utils/axios.ts` استفاده کنند
   - بررسی کنید `axios` به درستی پیکربندی شده باشد و `baseURL` صحیح داشته باشد
   - در کنسول مرورگر ببینید چه خطایی دریافت می‌کنید

3. **مشکل در بخش پرداخت‌ها**:
   - این بخش احتمالاً درخواست‌های پیچیده‌تری دارد یا از فرمت‌های خاصی استفاده می‌کند
   - بررسی کنید دیتای ارسالی به API به فرمت درستی باشد (تاریخ، اعداد، ...)
   - کنسول مرورگر را بررسی کنید تا جزئیات خطای دقیق را ببینید

### ۳. راه حل‌های خاص برای بخش پرداخت‌ها

برای رفع مشکل در بخش پرداخت‌ها، این مراحل را انجام دهید:

1. **بررسی دقیق خطا**:
   - در کنسول مرورگر، وقتی وارد صفحه پرداخت‌ها می‌شوید، خطای دقیق را بررسی کنید
   - آیا خطای 401 است یا خطای دیگری؟

2. **بررسی باندل شدن کد**:
   - گاهی تغییرات در کد به درستی باندل نمی‌شوند
   - فرانت‌اند را کامل ری‌استارت کنید (سرور توسعه را متوقف و دوباره اجرا کنید)

3. **تقویت بخش لاگینگ**:
   - لاگ‌های بیشتری به بخش مدیریت پرداخت‌ها اضافه کنید تا بهتر بتوانید مشکل را ردیابی کنید
   - وضعیت توکن را قبل و بعد از هر درخواست API بررسی کنید

4. **رویکرد خاص برای بخش پرداخت‌ها**:
   - اگر همچنان مشکل دارید، می‌توانید یک تابع `refreshToken` اختصاصی برای این بخش پیاده‌سازی کنید
   - قبل از هر درخواست در این بخش، توکن را مجدداً بررسی کنید

### ۴. مسیر پیشرو

اگر هنوز با بخش پرداخت‌ها مشکل دارید، این مراحل را انجام دهید:

1. خطای دقیق دریافتی در کنسول مرورگر را بررسی و ثبت کنید
2. بررسی کنید آیا خطا مربوط به فرمت داده‌ها (مثل تاریخ، اعداد فارسی) است یا مربوط به احراز هویت
3. بخش پرداخت‌ها را با توجه به الگوی سایر بخش‌های کارکرد بازنویسی کنید
4. در صورت نیاز، کل مرورگر را بسته و دوباره باز کنید تا کش کاملاً پاک شود

این داکیومنت به شما کمک می‌کند تا در آینده بتوانید مشکلات مشابه را عیب‌یابی و رفع کنید.
